box: java

dev:
  steps:
    - script:
        name: run gradle bootRun
        code: |
          ./gradlew bootRun

test:
  steps:
    - script:
        name: run gradle test
        code: |
          ./gradlew --full-stacktrace --project-cache-dir=$WERCKER_CACHE_DIR test
    - script:
        name: save output
        code: |
          cp -R ./ ${WERCKER_OUTPUT_DIR}

# create-version:
#   box: google/golang
#   steps:
#     - script:
#         name: install packages
#         code: |
#           sudo apt-get update -y
#           sudo apt-get install -y wget
#     - script:
#         name: bump version
#         code: |
#           ls -al
#           git branch
#           git tag -l
#           go get github.com/xchapter7x/versioning
#           export WERCKER_GITHUB_CREATE_RELEASE_ID=$(versioning bump_patch)
#           echo "WERCKER_GITHUB_CREATE_RELEASE_ID = $WERCKER_GITHUB_CREATE_RELEASE_ID"
#           $(echo $WERCKER_GITHUB_CREATE_RELEASE_ID | cut -c2-6 > $WERCKER_OUTPUT_DIR/version)
#     - script:
#         name: save output
#         code: |
#           cp -R ./ ${WERCKER_OUTPUT_DIR}

build:
  steps:
    - wercker/add-ssh-key@1.0.2:
        keyname: GITHUB_SSH_KEY
    - add-to-known_hosts:
        hostname: github.com
        fingerprint: 61:ea:15:12:08:34:23:0a:2e:1c:5f:18:55:39:d3:70
    - script:
        name: run gradle release tag
        code: |
          ./gradlew --full-stacktrace --project-cache-dir=$WERCKER_CACHE_DIR ./gradlew release tag
    - script:
        name: get version
        code: |
          pwd
          ls -al
          git branch
          export WERCKER_GITHUB_CREATE_RELEASE_ID=$(./gradlew -q printVersion)
          $(echo $WERCKER_GITHUB_CREATE_RELEASE_ID | cut -c2-6 > $WERCKER_OUTPUT_DIR/version)
          echo "WERCKER_OUTPUT_DIR = $WERCKER_OUTPUT_DIR"
          ls -al $WERCKER_OUTPUT_DIR/
          echo "WERCKER_GITHUB_CREATE_RELEASE_ID=$WERCKER_GITHUB_CREATE_RELEASE_ID"
          git tag -l
    - script:
        name: run gradle build
        code: |
          ./gradlew -Pversion=$WERCKER_GITHUB_CREATE_RELEASE_ID --full-stacktrace --project-cache-dir=$WERCKER_CACHE_DIR build
    - script:
        name: save output
        code: |
          cp -R ./ ${WERCKER_OUTPUT_DIR}

deploy:
  box: google/golang
  steps:
    - script:
        name: install packages
        code: |
          sudo apt-get update -y
          sudo apt-get install -y ssh wget
    - script:
        name: set version
        code: |
          export WERCKER_GITHUB_CREATE_RELEASE_ID=$(cat version)
          echo "WERCKER_GITHUB_CREATE_RELEASE_ID=$WERCKER_GITHUB_CREATE_RELEASE_ID"
          export APP_VERSION=$WERCKER_GITHUB_CREATE_RELEASE_ID
    - xchapter7x/cf-push-zdd:
        num_instances: $CF_INSTANCES
        user_name: $CF_USER
        user_pass: $CF_PASS
        org: $CF_ORG
        space: $CF_SPACE
        api_url: $CF_APIURL
        app_name: $CF_APPNAME
        use_manifest: true
        manifest: $CF_MANIFEST_FILE_PATH
        path: build/libs/sample-spring-cloud-svc-$APP_VERSION.jar
    - wercker/add-ssh-key@1.0.2:
        keyname: GITHUB_SSH_KEY
    - add-to-known_hosts:
        hostname: github.com
        fingerprint: 61:ea:15:12:08:34:23:0a:2e:1c:5f:18:55:39:d3:70
    - github-create-release:
        token: $GITHUB_TOKEN
        tag: $WERCKER_GITHUB_CREATE_RELEASE_ID
        title: Sample Spring Cloud Service $WERCKER_GITHUB_CREATE_RELEASE_ID
        draft: $RELEASE_DRAFT
    - github-upload-asset:
        token: $GITHUB_TOKEN
        file: build/libs/sample-spring-cloud-svc-$APP_VERSION.jar
        content-type: application/x-gzip

smoke-test:
  steps:
    - script:
      name: run gradle bootRun
      code: |
        ./mvnw test -P smoke -Durl=${APP_URL}/message

acceptance-test:
  steps:
    - script:
      name: run gradle cfAcceptanceTest
      code: |
        ./gradlew cfAcceptanceTest
